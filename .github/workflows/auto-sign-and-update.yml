name: Auto Sign and Update SourceGit

on:
  # Manual trigger
  workflow_dispatch:
    inputs:
      version:
        description: 'SourceGit version (e.g., v8.40)'
        required: true
  
  # Auto-check for new releases weekly
  schedule:
    - cron: '0 6 * * 1' # Every Monday at 6 AM UTC
  
  # Watch SourceGit releases (requires repository_dispatch from main repo)
  repository_dispatch:
    types: [sourcegit-release]

jobs:
  check-and-sign:
    runs-on: macos-latest
    
    steps:
      - name: Checkout tap repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}
      
      - name: Get latest SourceGit release
        id: latest_release
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(curl -s https://api.github.com/repos/sourcegit-scm/sourcegit/releases/latest | jq -r .tag_name)
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "version_num=${VERSION#v}" >> $GITHUB_OUTPUT
          echo "Found version: $VERSION"
      
      - name: Check if already signed
        id: check_exists
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          if gh release view "${VERSION}-signed" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "Version ${VERSION} already signed"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "Version ${VERSION} needs signing"
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Download SourceGit
        if: steps.check_exists.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          VERSION_NUM="${{ steps.latest_release.outputs.version_num }}"
          
          curl -L -o sourcegit.tar.gz \
            "https://github.com/sourcegit-scm/sourcegit/releases/download/${VERSION}/sourcegit_${VERSION_NUM}_osx-x64.tar.gz"
          
          tar -xzf sourcegit.tar.gz
          ls -la
      
      - name: Import signing certificate
        if: steps.check_exists.outputs.exists == 'false'
        env:
          CERTIFICATE_BASE64: ${{ secrets.APPLE_CERTIFICATE_BASE64 }}
          CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
        run: |
          # Create temporary keychain
          security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security default-keychain -s build.keychain
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
          security set-keychain-settings -t 3600 -u build.keychain
          
          # Decode and import certificate
          echo "$CERTIFICATE_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k build.keychain \
            -P "$CERTIFICATE_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign
          
          # Allow codesign access
          security set-key-partition-list -S apple-tool:,apple: \
            -s -k "$KEYCHAIN_PASSWORD" build.keychain
          
          # List identities to verify
          security find-identity -v
      
      - name: Sign application
        if: steps.check_exists.outputs.exists == 'false'
        env:
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
        run: |
          # Create entitlements file
          cat > entitlements.plist << 'EOF'
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
              <key>com.apple.security.cs.allow-jit</key>
              <true/>
              <key>com.apple.security.cs.allow-unsigned-executable-memory</key>
              <true/>
              <key>com.apple.security.cs.disable-library-validation</key>
              <true/>
          </dict>
          </plist>
          EOF
          
          # Sign all frameworks and dylibs first
          find SourceGit.app/Contents -type f \( -name "*.dylib" -o -name "*.framework" \) -exec \
            codesign --force --sign "$APPLE_IDENTITY" \
            --options runtime \
            --timestamp {} \; || true
          
          # Sign all executables
          find SourceGit.app/Contents/MacOS -type f -perm +111 -exec \
            codesign --force --sign "$APPLE_IDENTITY" \
            --options runtime \
            --entitlements entitlements.plist \
            --timestamp {} \;
          
          # Sign the app bundle itself
          codesign --force --sign "$APPLE_IDENTITY" \
            --options runtime \
            --entitlements entitlements.plist \
            --timestamp \
            --deep \
            SourceGit.app
          
          # Verify signature
          codesign --verify --deep --strict --verbose=2 SourceGit.app
          spctl --assess --type execute --verbose SourceGit.app
      
      - name: Create DMG
        if: steps.check_exists.outputs.exists == 'false'
        env:
          APPLE_IDENTITY: ${{ secrets.APPLE_IDENTITY }}
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          
          # Create DMG
          hdiutil create -volname "SourceGit" \
            -srcfolder SourceGit.app \
            -ov -format UDZO \
            SourceGit-${VERSION}-signed.dmg
          
          # Sign the DMG
          codesign --force --sign "$APPLE_IDENTITY" \
            --timestamp \
            SourceGit-${VERSION}-signed.dmg
          
          # Verify DMG signature
          codesign --verify --verbose SourceGit-${VERSION}-signed.dmg
      
      - name: Notarize application
        if: steps.check_exists.outputs.exists == 'false'
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          
          echo "Submitting for notarization..."
          xcrun notarytool submit SourceGit-${VERSION}-signed.dmg \
            --apple-id "$APPLE_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --team-id "$APPLE_TEAM_ID" \
            --wait \
            --timeout 30m
          
          echo "Stapling notarization ticket..."
          xcrun stapler staple SourceGit-${VERSION}-signed.dmg
          
          echo "Verifying notarization..."
          spctl --assess --type open --context context:primary-signature \
            -vv SourceGit-${VERSION}-signed.dmg
          
          echo "✅ Notarization complete!"
      
      - name: Calculate SHA256
        if: steps.check_exists.outputs.exists == 'false'
        id: sha256
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          SHA256=$(shasum -a 256 SourceGit-${VERSION}-signed.dmg | cut -d' ' -f1)
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT
          echo "SHA256: $SHA256"
      
      - name: Create GitHub Release
        if: steps.check_exists.outputs.exists == 'false'
        uses: softprops/action-gh-release@v1
        with:
          files: SourceGit-${{ steps.latest_release.outputs.version }}-signed.dmg
          tag_name: ${{ steps.latest_release.outputs.version }}-signed
          name: SourceGit ${{ steps.latest_release.outputs.version }} (Signed & Notarized)
          body: |
            **Signed and notarized build of SourceGit ${{ steps.latest_release.outputs.version }}**
            
            - ✅ Code signed with Developer ID
            - ✅ Notarized by Apple
            - ✅ No `--no-quarantine` flag needed
            
            Original release: https://github.com/sourcegit-scm/sourcegit/releases/tag/${{ steps.latest_release.outputs.version }}
            
            SHA256: `${{ steps.sha256.outputs.sha256 }}`
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Update cask formula
        if: steps.check_exists.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          VERSION_NUM="${{ steps.latest_release.outputs.version_num }}"
          SHA256="${{ steps.sha256.outputs.sha256 }}"
          
          # Create/update the cask file
          cat > Casks/sourcegit.rb << EOF
          cask "sourcegit" do
            version "${VERSION_NUM}"
            sha256 "${SHA256}"
            
            url "https://github.com/ybeapps/homebrew-sourcegit/releases/download/${VERSION}-signed/SourceGit-${VERSION}-signed.dmg"
            name "SourceGit"
            desc "Git GUI client"
            homepage "https://github.com/sourcegit-scm/sourcegit"
            
            # Signed and notarized - no --no-quarantine needed!
            app "SourceGit.app"
            
            zap trash: [
              "~/Library/Application Support/SourceGit",
              "~/Library/Saved Application State/com.sourcegit.app.savedState",
            ]
          end
          EOF
          
          echo "Updated cask formula:"
          cat Casks/sourcegit.rb
      
      - name: Commit and push changes
        if: steps.check_exists.outputs.exists == 'false'
        run: |
          VERSION="${{ steps.latest_release.outputs.version }}"
          
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          git add Casks/sourcegit.rb
          git commit -m "Update SourceGit to ${VERSION} (signed & notarized)"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GH_TOKEN }}
      
      - name: Cleanup
        if: always()
        run: |
          security delete-keychain build.keychain || true
          rm -f certificate.p12 entitlements.plist
